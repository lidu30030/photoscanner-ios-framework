name: build-photoscanner-library

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug list
        shell: bash
        run: |
          set -e
          pwd
          ls -la
          echo "=== src ==="
          ls -la src || true
          echo "=== dcloud_inc ==="
          ls -la dcloud_inc || true

      - name: Build static library
        shell: bash
        run: |
          set -euo pipefail

          ROOT="$PWD"
          OUT="$ROOT/out"
          BUILD="$ROOT/build"
          INC="$ROOT/dcloud_inc"
          SRC="$ROOT/src/PhotoScanner.m"

          rm -rf "$OUT" "$BUILD"
          mkdir -p "$OUT" "$BUILD/iphoneos"

          IOS_SDK="$(xcrun --sdk iphoneos --show-sdk-path)"

          COMMON_FLAGS="-fobjc-arc -fmodules -fvisibility=hidden -I$INC"

          xcrun clang -c "$SRC" \
            -arch armv7 -isysroot "$IOS_SDK" \
            -miphoneos-version-min=8.0 \
            $COMMON_FLAGS \
            -o "$BUILD/iphoneos/PhotoScanner_armv7.o"

          xcrun clang -c "$SRC" \
            -arch arm64 -isysroot "$IOS_SDK" \
            -miphoneos-version-min=8.0 \
            $COMMON_FLAGS \
            -o "$BUILD/iphoneos/PhotoScanner_arm64.o"

          xcrun libtool -static -o "$BUILD/iphoneos/libPhotoScanner_armv7.a" "$BUILD/iphoneos/PhotoScanner_armv7.o"
          xcrun libtool -static -o "$BUILD/iphoneos/libPhotoScanner_arm64.a" "$BUILD/iphoneos/PhotoScanner_arm64.o"

          lipo -create \
            "$BUILD/iphoneos/libPhotoScanner_armv7.a" \
            "$BUILD/iphoneos/libPhotoScanner_arm64.a" \
            -output "$OUT/libPhotoScanner.a"

          lipo -info "$OUT/libPhotoScanner.a"

          PKG="$OUT/nativeplugins/Keall-Photoscanner"
          mkdir -p "$PKG/ios"
          cp "$OUT/libPhotoScanner.a" "$PKG/ios/libPhotoScanner.a"
          cp "$ROOT/nativeplugins/Keall-Photoscanner/package.json" "$PKG/package.json"
          cd "$OUT"
          zip -r nativeplugins-Keall-Photoscanner.zip nativeplugins

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nativeplugins-Keall-Photoscanner.zip
          path: out/nativeplugins-Keall-Photoscanner.zip
