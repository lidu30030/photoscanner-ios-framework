name: build-photoscanner-framework

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug list
        shell: bash
        run: |
          set -e
          pwd
          ls -la
          echo "=== src ==="
          ls -la src || true
          echo "=== dcloud_inc ==="
          ls -la dcloud_inc || true

      - name: Build dynamic framework
        shell: bash
        run: |
          set -euo pipefail

          ROOT="$PWD"
          OUT="$ROOT/out"
          BUILD="$ROOT/build"
          INC="$ROOT/dcloud_inc"
          SRC="$ROOT/src/PhotoScanner.m"

          rm -rf "$OUT" "$BUILD"
          mkdir -p "$OUT" "$BUILD/iphoneos" "$BUILD/iphonesimulator"

          IOS_SDK="$(xcrun --sdk iphoneos --show-sdk-path)"
          SIM_SDK="$(xcrun --sdk iphonesimulator --show-sdk-path)"

          COMMON_FLAGS="-fobjc-arc -fmodules -fvisibility=hidden -I$INC"
          LINK_FLAGS="-Wl,-dead_strip -Wl,-undefined,dynamic_lookup"

          xcrun clang -c "$SRC" \
            -arch arm64 -isysroot "$IOS_SDK" \
            -miphoneos-version-min=12.0 \
            $COMMON_FLAGS \
            -o "$BUILD/iphoneos/PhotoScanner_arm64.o"

          xcrun clang -c "$SRC" \
            -arch arm64 -isysroot "$SIM_SDK" \
            -mios-simulator-version-min=12.0 \
            $COMMON_FLAGS \
            -o "$BUILD/iphonesimulator/PhotoScanner_sim_arm64.o"

          xcrun clang -c "$SRC" \
            -arch x86_64 -isysroot "$SIM_SDK" \
            -mios-simulator-version-min=12.0 \
            $COMMON_FLAGS \
            -o "$BUILD/iphonesimulator/PhotoScanner_sim_x86_64.o"

          xcrun clang -dynamiclib \
            -arch arm64 -isysroot "$IOS_SDK" \
            -miphoneos-version-min=12.0 \
            -install_name @rpath/PhotoScanner.framework/PhotoScanner \
            $LINK_FLAGS \
            -o "$BUILD/iphoneos/PhotoScanner" \
            "$BUILD/iphoneos/PhotoScanner_arm64.o"

          xcrun clang -dynamiclib \
            -arch arm64 -isysroot "$SIM_SDK" \
            -mios-simulator-version-min=12.0 \
            -install_name @rpath/PhotoScanner.framework/PhotoScanner \
            $LINK_FLAGS \
            -o "$BUILD/iphonesimulator/PhotoScanner_arm64" \
            "$BUILD/iphonesimulator/PhotoScanner_sim_arm64.o"

          xcrun clang -dynamiclib \
            -arch x86_64 -isysroot "$SIM_SDK" \
            -mios-simulator-version-min=12.0 \
            -install_name @rpath/PhotoScanner.framework/PhotoScanner \
            $LINK_FLAGS \
            -o "$BUILD/iphonesimulator/PhotoScanner_x86_64" \
            "$BUILD/iphonesimulator/PhotoScanner_sim_x86_64.o"

          lipo -create \
            "$BUILD/iphonesimulator/PhotoScanner_arm64" \
            "$BUILD/iphonesimulator/PhotoScanner_x86_64" \
            -output "$BUILD/iphonesimulator/PhotoScanner"

          lipo -info "$BUILD/iphoneos/PhotoScanner"
          lipo -info "$BUILD/iphonesimulator/PhotoScanner"

          FW="$OUT/PhotoScanner.framework"
          mkdir -p "$FW/Headers" "$FW/Modules"

          cp "$BUILD/iphoneos/PhotoScanner" "$FW/PhotoScanner"
          cp "$ROOT/src/PhotoScanner.h" "$FW/Headers/PhotoScanner.h"

          cat > "$FW/Modules/module.modulemap" <<'EOF'
          framework module PhotoScanner {
            header "PhotoScanner.h"
            export *
          }
          EOF

          cat > "$FW/Info.plist" <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleDevelopmentRegion</key><string>en</string>
            <key>CFBundleExecutable</key><string>PhotoScanner</string>
            <key>CFBundleIdentifier</key><string>com.photoscanner.framework</string>
            <key>CFBundleInfoDictionaryVersion</key><string>6.0</string>
            <key>CFBundleName</key><string>PhotoScanner</string>
            <key>CFBundlePackageType</key><string>FMWK</string>
            <key>CFBundleShortVersionString</key><string>1.0.0</string>
            <key>CFBundleVersion</key><string>1</string>
          </dict>
          </plist>
          EOF

          cd "$OUT"
          file PhotoScanner.framework/PhotoScanner
          zip -r PhotoScanner.framework.zip PhotoScanner.framework

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: PhotoScanner.framework.zip
          path: out/PhotoScanner.framework.zip
